<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>맛집 — 여의도 태영빌딩 주변</title>
  <meta name="description" content="여의도 태영빌딩 주변 맛집 지도 & 분류 필터"/>
  <style>
    :root{ --bg:#0f172a; --panel:#111827ee; --text:#e5e7eb; --muted:#9aa3af; --accent:#60a5fa; --accent2:#34d399; --border:#1f2937;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;background:radial-gradient(1200px 800px at 80% -10%,#1f2937 0%,#0b1225 50%,#020617 100%);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline;opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;backdrop-filter:saturate(140%) blur(8px);background:#030712aa;border-bottom:1px solid #111827;z-index:50}
    nav{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .brand{font-weight:800;letter-spacing:.2px}
    .brand span{color:var(--accent2)}
    .navlinks{display:flex;gap:18px;flex-wrap:wrap}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#7dd3fc);color:#02131e;border-color:transparent;font-weight:700}
    .btn.light{background:#ffffff;color:#111827;border-color:#e5e7eb}
    .grid{display:grid;gap:18px}
    @media(min-width:1024px){ .grid.cols-2{grid-template-columns:1fr 480px} }  /* 좌:지도, 우:패널 */
    .card{background:linear-gradient(180deg,#0b1220 0%,#0a0f1a 100%);border:1px solid var(--border);border-radius:18px;padding:18px}
    .section-title{display:flex;align-items:center;gap:10px;margin:0 0 12px}
    .section-title .bar{width:28px;height:2px;background:var(--accent);opacity:.85}
    .muted{color:#9aa3b2}
    .footer{border-top:1px solid #111827;margin-top:28px;padding-top:16px;color:#9aa3b2}

    /* 우측 패널 */
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .chip{
      padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;
      cursor:pointer;background:#ffffff;color:#111827;font-size:14px;font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.08)
    }
    .chip.active{outline:2px solid #111827;background:#f3f4f6}
    #place-list{list-style:none;padding:0;margin:0;display:grid;gap:10px;max-height:420px;overflow:auto}
    #place-list li{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0b1220;cursor:pointer}
    #place-list li:hover{border-color:#243043}
    #place-list .title{font-weight:700}
    #place-list .cat{font-size:12px;color:#9aa3b2}
    #detail{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    #map{height:600px;border-radius:14px;overflow:hidden}
    @media(max-width:1023px){ #map{height:380px} }

    /* 오늘 뭐먹지 */
    .pick-box{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pick-name{font-size:18px;font-weight:800}
    .pill{padding:6px 10px;border:1px solid #243043;border-radius:999px;background:#0b1220}

    /* 사다리 */
    .ladder-config{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .ladder-config .field{display:flex;flex-direction:column;gap:6px}
    .ladder-grid{display:grid;gap:8px}
    .ladder-names, .ladder-results{display:grid;gap:8px}
    .ladder-names input, .ladder-results input{
      width:120px;max-width:140px;padding:8px 10px;border-radius:10px;border:1px solid #243043;background:#0b1220;color:var(--text)
    }
    .ladder-wrap{overflow:auto}
    svg.ladder{width:100%;min-width:560px;background:#08101b;border-radius:12px;border:1px solid #1f2937}
    .result-list{display:grid;gap:6px;margin-top:12px}
    .result-item{display:flex;justify-content:space-between;gap:10px;padding:8px 12px;border:1px solid #243043;border-radius:10px;background:#0b1220}
  </style>
</head>
<body>
<header>
  <div class="container">
    <nav>
      <div class="brand">내 홈페이지 <span>Matjip</span></div>
      <div class="navlinks">
        <!-- 모두 상대경로! (프로젝트 페이지/유저 페이지 둘 다 호환) -->
        <a href="index.html">Home</a>
        <a href="stock.html">Stock Market</a>
        <a href="matjip.html">맛집</a>
        <a href="index.html#contact" class="btn primary">문의하기</a>
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid cols-2">
    <!-- 왼쪽: 지도 -->
    <section class="card" style="padding:12px">
      <div class="section-title"><div class="bar"></div><h2 style="margin:0">여의도 태영빌딩 중심 지도</h2></div>
      <div id="map"></div>
      <p class="muted" style="margin-top:8px">* 반경 내 음식점을 자동으로 불러옵니다. (카카오 지도)</p>
    </section>

    <!-- 오른쪽: 목록 + 상세 -->
    <aside class="card">
      <div class="section-title"><div class="bar"></div><h2 style="margin:0">주변 맛집</h2></div>

      <div class="filters" id="filters"></div>

      <ul id="place-list">
        <li class="muted">지도를 불러오는 중…</li>
      </ul>

      <div id="detail"></div>
    </aside>
  </div>

  <!-- 오늘 뭐먹지? -->
  <section class="card" id="what-to-eat">
    <div class="section-title"><div class="bar"></div><h2 style="margin:0">오늘 뭐먹지?</h2></div>
    <div class="pick-box">
      <span id="pick-name" class="pick-name muted">식당을 불러오는 중…</span>
      <span id="pick-meta" class="pill muted"></span>
      <button id="pick-refresh" class="btn light">다시 뽑기</button>
    </div>
    <p class="muted" style="margin-top:8px">현재 지도에 표시된(필터 반영) 식당 중 하나를 무작위로 추천합니다.</p>
  </section>

  <!-- 사다리타기 -->
  <section class="card" id="ladder-section">
    <div class="section-title"><div class="bar"></div><h2 style="margin:0">사다리타기 (3~8인)</h2></div>

    <div class="ladder-config">
      <div class="field">
        <label>인원수 (3~8)</label>
        <input type="number" id="player-count" min="3" max="8" value="4" style="width:120px;padding:8px 10px;border-radius:10px;border:1px solid #243043;background:#0b1220;color:var(--text)"/>
      </div>
      <div class="field">
        <label>당첨 개수</label>
        <input type="number" id="win-count" min="0" max="8" value="1" style="width:120px;padding:8px 10px;border-radius:10px;border:1px solid #243043;background:#0b1220;color:var(--text)"/>
      </div>
      <div class="field">
        <label>꽝 개수</label>
        <input type="number" id="lose-count" min="0" max="8" value="1" style="width:120px;padding:8px 10px;border-radius:10px;border:1px solid #243043;background:#0b1220;color:var(--text)"/>
      </div>
      <div class="field" style="align-self:flex-end;">
        <button id="build-ladder" class="btn light">사다리 만들기</button>
      </div>
      <div class="field" style="align-self:flex-end;">
        <button id="shuffle-ladder" class="btn">랜덤 추첨</button>
      </div>
    </div>

    <div class="ladder-grid" id="ladder-inputs">
      <div class="ladder-names" id="ladder-names"></div>
      <div class="ladder-results" id="ladder-results"></div>
    </div>

    <div class="ladder-wrap" style="margin-top:12px">
      <svg class="ladder" id="ladder-svg" height="360" viewBox="0 0 900 360" preserveAspectRatio="none"></svg>
    </div>

    <div class="result-list" id="ladder-output"></div>
  </section>

  <div class="footer">
    <small>© <span id="year"></span> 내 홈페이지 · 모든 권리 보유</small>
  </div>
</main>

<!-- Kakao Maps JS (services=Places/Geocoder), autoload=false 필수 -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=6096c5ef0866cfa555f1040e3f21bc62&libraries=services&autoload=false"></script>
<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // ---- 1) 카테고리 정의/매핑 ----
  const CATEGORIES = ['전체','한식','중식','일식','양식','카페','기타'];
  function mapCuisine(catName=''){
    const c = catName.toLowerCase();
    if (c.includes('한식') || c.includes('분식') || c.includes('치킨') || c.includes('고기') || c.includes('국밥')) return '한식';
    if (c.includes('중식') || c.includes('중화')) return '중식';
    if (c.includes('일식') || c.includes('스시') || c.includes('돈까스') || c.includes('라멘')) return '일식';
    if (c.includes('양식') || c.includes('이탈리아') || c.includes('피자') || c.includes('버거') || c.includes('스테이크') || c.includes('파스타')) return '양식';
    if (c.includes('카페') || c.includes('디저트') || c.includes('제과')) return '카페';
    return '기타';
  }

  // ---- 2) SDK 로드 완료 후 init ----
  kakao.maps.load(initMap);

  let map, places, ALL_RESULTS=[], MARKERS=[], CURRENT_FILTER='전체';

  function initMap(){
    const mapEl = document.getElementById('map');
    map = new kakao.maps.Map(mapEl, { center: new kakao.maps.LatLng(37.523, 126.926), level: 4 });
    places = new kakao.maps.services.Places(map);

    // 태영빌딩 주소 → 좌표로 중심 이동
    const geocoder = new kakao.maps.services.Geocoder();
    geocoder.addressSearch('서울 영등포구 여의공원로 111', (res, status) => {
      if (status === kakao.maps.services.Status.OK && res[0]) {
        const center = new kakao.maps.LatLng(res[0].y, res[0].x);
        map.setCenter(center);
        new kakao.maps.Marker({ map, position: center, title: '태영빌딩' });
        loadPlaces(center);
      } else {
        // 지오코딩 실패 시 현재 중심으로라도 검색
        loadPlaces(map.getCenter());
      }
    });

    renderFilterChips();
    setupWhatToEat();
    setupLadder();
  }

  // ---- 3) 반경 내 음식점 검색(FD6) ----
  function loadPlaces(center){
    ALL_RESULTS=[]; clearMarkers();

    const opts = { location:center, radius:800 }; // 800m 반경
    const accum = (data,status,pag)=>{
      if(status === kakao.maps.services.Status.OK){
        ALL_RESULTS = ALL_RESULTS.concat(data);
        if (pag && pag.hasNextPage) pag.nextPage();
        else { renderList(); renderMarkers(); refreshPick(); }
      }else{
        document.getElementById('place-list').innerHTML = '<li class="muted">주변에서 식당을 찾지 못했습니다.</li>';
        refreshPick(); // 빈 상태 처리
      }
    };

    places.categorySearch('FD6', accum, opts);
  }

  // ---- 4) 필터/목록/상세/마커 ----
  function renderFilterChips(){
    const box = document.getElementById('filters');
    box.innerHTML='';
    CATEGORIES.forEach(cat=>{
      const el = document.createElement('button');
      el.className = 'chip' + (cat===CURRENT_FILTER ? ' active':'');
      el.textContent = cat;
      el.addEventListener('click', ()=>{
        CURRENT_FILTER = cat;
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        renderList(); renderMarkers();
        document.getElementById('detail').innerHTML='';
        refreshPick();
      });
      box.appendChild(el);
    });
  }

  function byFilter(item){
    if (CURRENT_FILTER==='전체') return true;
    return mapCuisine(item.category_name) === CURRENT_FILTER;
  }

  function renderList(){
    const ul = document.getElementById('place-list');
    const items = ALL_RESULTS.filter(byFilter);
    if (!items.length){ ul.innerHTML = '<li class="muted">해당 분류의 식당이 없습니다.</li>'; return; }
    ul.innerHTML = '';
    items.forEach(item=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="title">${item.place_name}</div>
        <div class="cat">${item.category_name} · ${item.road_address_name || item.address_name || ''}</div>
      `;
      li.addEventListener('click', ()=> showDetail(item));
      ul.appendChild(li);
    });
  }

  function clearMarkers(){ MARKERS.forEach(m=>m.setMap(null)); MARKERS=[]; }

  function renderMarkers(){
    clearMarkers();
    const items = ALL_RESULTS.filter(byFilter);
    const bounds = new kakao.maps.LatLngBounds();
    items.forEach(item=>{
      const pos = new kakao.maps.LatLng(item.y, item.x);
      const marker = new kakao.maps.Marker({ map, position: pos, title: item.place_name });
      kakao.maps.event.addListener(marker, 'click', ()=> showDetail(item));
      MARKERS.push(marker);
      bounds.extend(pos);
    });
    if (items.length) map.setBounds(bounds, 40, 40, 40, 40);
  }

  // ---- 5) (선택) 커스텀 메뉴 JSON 로딩 ----
  // 레포 루트 기준: ./data/menus.json  (없어도 동작)
  let MENU_MAP=null;
  fetch('data/menus.json').then(r=>r.ok ? r.json() : null).then(j=>MENU_MAP=j).catch(()=>{});

  function showDetail(item){
    const box = document.getElementById('detail');
    const cuisine = mapCuisine(item.category_name);
    const tel = item.phone || '전화정보 없음';
    const addr = item.road_address_name || item.address_name || '';

    const naverLink = `https://map.naver.com/v5/search/${encodeURIComponent(item.place_name)}`;
    const googleLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.place_name + ' ' + addr)}`;

    // 기본: 외부 링크(카카오/네이버/구글). 커스텀 menus.json 있으면 그걸 우선 표시.
    let menuHTML = `<div class="muted">* 메뉴는 외부 페이지를 참고하세요.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <a class="btn" href="${item.place_url}" target="_blank" rel="noopener">카카오에서 보기</a>
        <a class="btn" href="${naverLink}" target="_blank" rel="noopener">네이버에서 보기</a>
        <a class="btn" href="${googleLink}" target="_blank" rel="noopener">구글에서 보기</a>
      </div>`;

    if (MENU_MAP) {
      const key = item.id || (item.place_name + (item.phone||'')).toLowerCase();
      const custom = MENU_MAP[key];
      if (Array.isArray(custom) && custom.length){
        menuHTML = `<ul style="list-style:none;padding:0;margin-top:6px;display:grid;gap:6px">
          ${custom.map(m => `<li>· ${m.name}${m.price ? ` — <span class="muted">${m.price}</span>` : ''}</li>`).join('')}
        </ul>`;
      }
    }

    box.innerHTML = `
      <div class="section-title"><div class="bar"></div><h3 style="margin:0">${item.place_name}</h3></div>
      <p class="muted" style="margin:4px 0 10px">${item.category_name} · 분류: ${cuisine}</p>
      <p style="margin:0 0 6px">주소: ${addr}</p>
      <p style="margin:0 0 10px">전화: ${tel}</p>
      <div><strong>메뉴</strong>${menuHTML}</div>
    `;
  }

  // ===============================
  // [오늘 뭐먹지?] 랜덤 추천
  // ===============================
  function setupWhatToEat(){
    document.getElementById('pick-refresh').addEventListener('click', refreshPick);
  }

  function getFilteredItems(){
    return ALL_RESULTS.filter(byFilter);
  }

  function refreshPick(){
    const nameEl = document.getElementById('pick-name');
    const metaEl = document.getElementById('pick-meta');
    const items = getFilteredItems();
    if (!items.length){
      nameEl.textContent = '추천할 식당이 없습니다.';
      nameEl.classList.add('muted');
      metaEl.textContent = '';
      return;
    }
    const pick = items[Math.floor(Math.random()*items.length)];
    nameEl.textContent = pick.place_name;
    nameEl.classList.remove('muted');
    metaEl.textContent = `${pick.category_name} · ${pick.road_address_name || pick.address_name || ''}`;
  }

  // ===============================
  // 사다리타기 (3~8인, 당첨/꽝 개수)
  // ===============================
  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>사다리 타기 게임</title>
  <style>
    :root{--bg:#0b1225;--panel:#101827;--text:#e5e7eb;--muted:#9aa3af;--accent:#38bdf8;--good:#34d399;--bad:#f87171;--border:#1f2937}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 800px at 80% -10%,#1f2937 0%,#0b1225 50%,#020617 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:color-mix(in oklab,var(--panel),black 10%);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0 0 12px;font-size:24px;font-weight:800}
    h3{margin:0 0 12px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--text)}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
    .btn{background:#334155;color:#e5e7eb}
    .btn:hover{background:#475569}
    .btn-primary{background:var(--accent);color:#06111b}
    .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
    .note{font-size:12px;color:#9ca3af;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #3b4555;background:#0f172a;color:#cbd5e1;font-size:12px}
    .names .rowline{display:flex;gap:8px}
    .names input{flex:1}
    .names .show{background:#10b981;color:#062015}
    svg{width:100%;height:560px;background:#0b1225;border-radius:16px;border:1px solid var(--border)}
    .footer{font-size:12px;color:#94a3b8}
    .toast{margin-top:8px;font-size:13px;color:#c7eefc}
  </style>
</head>
<body>
<div class="wrap">
  <header style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <h1>사다리 타기 게임</h1>
    <div class="badge">통과/꽝만 · 경로 하이라이트</div>
  </header>

  <div class="row">
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h3>설정</h3>
        <div class="badge">3~8명</div>
      </div>
      <div class="grid cols-3">
        <div>
          <label>참가 인원</label>
          <input id="inpPlayers" type="number" min="3" max="8" value="4" />
        </div>
        <div>
          <label>통과 개수</label>
          <input id="inpPass" type="number" min="0" max="8" value="2" />
        </div>
        <div>
          <label>꽝 개수</label>
          <input id="inpFail" type="number" min="0" max="8" value="2" />
        </div>
      </div>
      <div class="note">* 통과+꽝 = 참가 인원이어야 시작할 수 있어요.</div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="btnStart" class="btn-primary">사다리 시작</button>
        <button id="btnReset" class="btn">리셋</button>
      </div>
      <div id="toast" class="toast"></div>
    </section>

    <section class="card names">
      <h3>이름 입력 (시작 후, 각자 결과를 클릭 공개)</h3>
      <div id="nameList" class="grid cols-2"></div>
      <div class="note">* 시작 후 각 이름 옆 <b>확인</b>을 눌러 그 사람의 사다리 경로만 하이라이트하고 결과를 공개합니다.</div>
    </section>
  </div>

  <div class="row" style="margin-top:16px">
    <section class="card" style="grid-column:1 / span 2">
      <svg id="ladderSvg" viewBox="0 0 1000 620"></svg>
    </section>
  </div>

  <div class="row" style="margin-top:16px">
    <section class="card" style="grid-column:1 / span 2">
      <h3>공개된 결과</h3>
      <ul id="revealList" style="list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:8px"></ul>
    </section>
  </div>

  <div class="footer" style="margin-top:10px">• 규칙: 참가 인원 3~8명, 결과는 "통과" 또는 "꽝"만. 이름 클릭 시 해당 경로만 하이라이트되어 결과가 공개됩니다.</div>
</div>

<script>
(function(){
  // --------- CONFIG ---------
  const MIN = 3, MAX = 8;
  const DEFAULT_ROWS = 12;     // 가로줄 층 수
  const RUNG_DENSITY = 0.35;   // 층당 가로줄 생성 확률

  // --------- STATE ---------
  let playerCount = 4;
  let names = Array.from({length:4}, (_,i)=>`사람${i+1}`);
  let passCount = 2;
  let failCount = 2;
  let started = false;
  /** ladder = { rows, cols, rungs:boolean[rows][cols-1] } */
  let ladder = null;
  /** bottomResults = ["통과"|"꽝"] length = cols */
  let bottomResults = [];
  /** revealedByTopIndex = { [topIdx]: { endCol, result } } */
  let revealedByTopIndex = {};
  /** highlight polyline points */
  let highlightPoints = null;

  // --------- DOM ---------
  const elPlayers = document.getElementById('inpPlayers');
  const elPass = document.getElementById('inpPass');
  const elFail = document.getElementById('inpFail');
  const elStart = document.getElementById('btnStart');
  const elReset = document.getElementById('btnReset');
  const elNameList = document.getElementById('nameList');
  const elSvg = document.getElementById('ladderSvg');
  const elReveal = document.getElementById('revealList');
  const elToast = document.getElementById('toast');

  // --------- SVG LAYOUT ---------
  const VIEW_W = 1000, VIEW_H = 620;
  const MARGIN_L = 90, MARGIN_R = 90;
  const TOP_Y = 80, BOTTOM_Y = 540;

  function setToast(msg){ elToast.textContent = msg || ''; }

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  function syncFailToPlayers(){
    failCount = clamp(playerCount - passCount, 0, playerCount);
    elFail.value = String(failCount);
  }

  function rebuildNameInputs(){
    elNameList.innerHTML = '';
    for(let i=0;i<playerCount;i++){
      const row = document.createElement('div');
      row.className = 'rowline';
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.value = names[i] || `사람${i+1}`;
      inp.disabled = started;
      inp.oninput = (e)=>{ names[i] = e.target.value; };
      const btn = document.createElement('button');
      btn.textContent = '확인';
      btn.className = 'btn show';
      btn.onclick = ()=> clickName(i);
      row.appendChild(inp); row.appendChild(btn);
      elNameList.appendChild(row);
    }
  }

  function countsValid(){ return (playerCount>=MIN && playerCount<=MAX && passCount>=0 && failCount>=0 && passCount + failCount === playerCount); }
  function namesValid(){ return names.length===playerCount && names.every(n=> (n||'').trim().length>0); }

  function generateLadder(cols, rows){
    const rungs = Array.from({length:rows}, ()=> Array(cols-1).fill(false));
    for(let r=0;r<rows;r++){
      let c=0;
      while(c<cols-1){
        if(Math.random()<RUNG_DENSITY){ rungs[r][c]=true; c+=2; }
        else c+=1;
      }
    }
    return { rows, cols, rungs };
  }

  function xPositions(){
    const innerW = VIEW_W - MARGIN_L - MARGIN_R;
    const gap = innerW / (playerCount - 1);
    return Array.from({length:playerCount}, (_,i)=> MARGIN_L + gap*i);
  }

  function yRungPositions(){
    const rows = ladder? ladder.rows : DEFAULT_ROWS;
    const h = BOTTOM_Y - TOP_Y;
    return Array.from({length:rows}, (_,r)=> TOP_Y + (h*(r+1))/(rows+1));
  }

  function tracePathPoints(startCol){
    if(!ladder) return {points:[], endCol:startCol};
    const xs = xPositions();
    const ys = yRungPositions();
    let col = startCol; const pts = [];
    pts.push([xs[col], TOP_Y]);
    for(let r=0;r<ladder.rows;r++){
      const y = ys[r];
      pts.push([xs[col], y]);
      if(ladder.rungs[r][col]){ pts.push([xs[col+1], y]); col = col+1; }
      else if(col>0 && ladder.rungs[r][col-1]){ pts.push([xs[col-1], y]); col = col-1; }
    }
    pts.push([xs[col], BOTTOM_Y]);
    return {points:pts, endCol:col};
  }

  function draw(){
    const xs = xPositions();
    const ys = yRungPositions();
    elSvg.innerHTML = '';

    // title
    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x', VIEW_W/2); title.setAttribute('y', 36);
    title.setAttribute('text-anchor','middle'); title.setAttribute('fill','#e5e7eb');
    title.style.fontSize='20px'; title.style.fontWeight='700';
    title.textContent = '사다리 타기';
    elSvg.appendChild(title);

    // top names & index
    xs.forEach((x,i)=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx',x); circle.setAttribute('cy', TOP_Y-24); circle.setAttribute('r',14);
      circle.setAttribute('fill','#1e293b'); circle.setAttribute('stroke','#334155');
      const tIdx = document.createElementNS('http://www.w3.org/2000/svg','text');
      tIdx.setAttribute('x',x); tIdx.setAttribute('y', TOP_Y-20); tIdx.setAttribute('text-anchor','middle'); tIdx.setAttribute('fill','#e5e7eb');
      tIdx.style.fontSize='12px'; tIdx.textContent = (i+1);
      const tName = document.createElementNS('http://www.w3.org/2000/svg','text');
      tName.setAttribute('x',x); tName.setAttribute('y', TOP_Y-38); tName.setAttribute('text-anchor','middle'); tName.setAttribute('fill','#cbd5e1');
      tName.style.fontSize='12px'; tName.textContent = names[i] || `사람${i+1}`;
      g.appendChild(circle); g.appendChild(tIdx); g.appendChild(tName);
      elSvg.appendChild(g);
    });

    // verticals
    xs.forEach((x)=>{
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',x); line.setAttribute('y1',TOP_Y); line.setAttribute('x2',x); line.setAttribute('y2',BOTTOM_Y);
      line.setAttribute('stroke','#475569'); line.setAttribute('stroke-width','3');
      elSvg.appendChild(line);
    });

    // rungs
    if(ladder){
      for(let r=0;r<ladder.rows;r++){
        for(let c=0;c<ladder.cols-1;c++){
          if(!ladder.rungs[r][c]) continue;
          const h = document.createElementNS('http://www.w3.org/2000/svg','line');
          h.setAttribute('x1', xs[c]); h.setAttribute('y1', ys[r]);
          h.setAttribute('x2', xs[c+1]); h.setAttribute('y2', ys[r]);
          h.setAttribute('stroke','#64748b'); h.setAttribute('stroke-width','4');
          elSvg.appendChild(h);
        }
      }
    }

    // highlight path
    if(highlightPoints && highlightPoints.length){
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
      poly.setAttribute('points', highlightPoints.map(p=>p.join(',')).join(' '));
      poly.setAttribute('fill','none'); poly.setAttribute('stroke','#22d3ee'); poly.setAttribute('stroke-width','8');
      poly.setAttribute('stroke-linejoin','round'); poly.setAttribute('stroke-linecap','round');
      poly.style.filter = 'drop-shadow(0 0 6px rgba(34,211,238,.6))';
      elSvg.appendChild(poly);
    }

    // bottom boxes
    xs.forEach((x,i)=>{
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', x-36); rect.setAttribute('y', BOTTOM_Y+16); rect.setAttribute('width', 72); rect.setAttribute('height', 28); rect.setAttribute('rx', 10);
      rect.setAttribute('fill','#0f172a'); rect.setAttribute('stroke','#334155');
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',x); t.setAttribute('y', BOTTOM_Y+35); t.setAttribute('text-anchor','middle'); t.style.fontSize='14px'; t.style.fontWeight='700';
      const revealedCols = new Set(Object.values(revealedByTopIndex).map(v=>v.endCol));
      const isRevealed = revealedCols.has(i);
      t.setAttribute('fill', isRevealed ? (bottomResults[i]==='통과'? '#34d399' : '#f87171') : '#94a3b8');
      t.textContent = isRevealed ? bottomResults[i] : '?';
      g.appendChild(rect); g.appendChild(t); elSvg.appendChild(g);
    });
  }

  function start(){
    setToast('');
    if(!countsValid()){ setToast('인원수와 통과/꽝 개수의 합을 확인하세요.'); return; }
    if(!namesValid()){ setToast('이름을 모두 입력해 주세요.'); return; }
    ladder = generateLadder(playerCount, DEFAULT_ROWS);
    bottomResults = shuffle([ ...Array(passCount).fill('통과'), ...Array(playerCount - passCount).fill('꽝') ]);
    revealedByTopIndex = {};
    highlightPoints = null;
    started = true;
    toggleInputs();
    draw();
  }

  function reset(){
    playerCount = 4; passCount = 2; failCount = 2; names = Array.from({length:4},(_,i)=>`사람${i+1}`);
    started = false; ladder = null; bottomResults = []; revealedByTopIndex = {}; highlightPoints = null; setToast('');
    elPlayers.value = '4'; elPass.value = '2'; elFail.value = '2';
    rebuildNameInputs(); toggleInputs(); draw();
  }

  function clickName(idx){
    if(!started || !ladder){ setToast("먼저 '사다리 시작'을 눌러 게임을 시작하세요."); return; }
    const {points, endCol} = tracePathPoints(idx);
    const result = bottomResults[endCol];
    highlightPoints = points;
    revealedByTopIndex[idx] = { endCol, result };
    setToast(`${names[idx]}: ${result==='통과'?'통과!':'꽝'}`);
    addRevealBadge(idx, endCol, result);
    draw();
  }

  function addRevealBadge(topIdx, endCol, result){
    // if already exists, update text
    let id = `re-${topIdx}`; let li = document.getElementById(id);
    const text = `${names[topIdx]} → ${result} (도착 ${endCol+1})`;
    if(!li){
      li = document.createElement('li');
      li.id = id;
      li.style.border = '1px solid var(--border)';
      li.style.background = '#0f172a';
      li.style.borderRadius = '12px';
      li.style.padding = '8px 10px';
      li.style.fontSize = '12px';
      li.style.display = 'flex';
      li.style.alignItems = 'center';
      li.style.gap = '8px';
      // view path button
      const btn = document.createElement('button');
      btn.textContent = '경로 보기'; btn.className='btn-primary'; btn.style.padding='6px 8px'; btn.style.fontSize='12px';
      btn.onclick = ()=>{ const {points}=tracePathPoints(Number(topIdx)); highlightPoints = points; draw(); };
      const span = document.createElement('span'); span.textContent = text; span.style.color = result==='통과'? 'var(--good)':'var(--bad)'; span.style.fontWeight='700'; span.id = `re-text-${topIdx}`;
      li.appendChild(span); li.appendChild(btn); elReveal.appendChild(li);
    } else {
      const span = document.getElementById(`re-text-${topIdx}`);
      if(span){ span.textContent = text; span.style.color = result==='통과'? 'var(--good)':'var(--bad)'; }
    }
  }

  function toggleInputs(){
    // disable inputs when started
    [...elNameList.querySelectorAll('input')].forEach(inp=> inp.disabled = started);
    elPlayers.disabled = started; elPass.disabled = started; elFail.disabled = started;
    elStart.disabled = started || !countsValid() || !namesValid();
  }

  // --------- INIT & EVENTS ---------
  elPlayers.addEventListener('input', (e)=>{
    const v = clamp(parseInt(e.target.value||'3',10), MIN, MAX);
    playerCount = v; e.target.value = String(v);
    // resize names
    if(names.length < v){ for(let i=names.length;i<v;i++) names.push(`사람${i+1}`); }
    else if(names.length > v){ names.length = v; }
    syncFailToPlayers(); rebuildNameInputs(); draw();
  });
  elPass.addEventListener('input', (e)=>{ passCount = clamp(parseInt(e.target.value||'0',10), 0, playerCount); e.target.value = String(passCount); syncFailToPlayers(); draw(); });
  elFail.addEventListener('input', (e)=>{ failCount = clamp(parseInt(e.target.value||'0',10), 0, playerCount); e.target.value = String(failCount); draw(); });

  elStart.addEventListener('click', start);
  elReset.addEventListener('click', reset);

  // initial render
  rebuildNameInputs(); draw(); toggleInputs();
})();
</script>
</body>
</html>

