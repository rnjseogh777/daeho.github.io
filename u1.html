<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>U1 빌딩 맛집 — 강동U1센터 주변</title>
  <meta name="description" content="서울 강동구 고덕비즈밸리로 26 강동U1센터 주변 맛집 지도 & 분류 필터"/>
  <style>
    :root{ --bg:#0f172a; --panel:#111827ee; --text:#e5e7eb; --muted:#9aa3af; --accent:#60a5fa; --accent2:#34d399; --border:#1f2937;}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;background:radial-gradient(1200px 800px at 80% -10%,#1f2937 0%,#0b1225 50%,#020617 100%);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline;opacity:.9}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;backdrop-filter:saturate(140%) blur(8px);background:#030712aa;border-bottom:1px solid #111827;z-index:50}
    nav{display:flex;justify-content:space-between;align-items:center;gap:16px}
    .brand{font-weight:800;letter-spacing:.2px}
    .brand span{color:var(--accent2)}
    .navlinks{display:flex;gap:18px;flex-wrap:wrap}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#7dd3fc);color:#02131e;border-color:transparent;font-weight:700}
    .btn.light{background:#ffffff;color:#111827;border-color:#e5e7eb}
    .btn.call{background:#34d399;color:#062015;border-color:#0e7e5a;font-weight:800}
    .grid{display:grid;gap:18px}
    @media(min-width:1024px){ .grid.cols-2{grid-template-columns:1fr 480px} }
    .card{background:linear-gradient(180deg,#0b1220 0%,#0a0f1a 100%);border:1px solid var(--border);border-radius:18px;padding:18px}
    .section-title{display:flex;align-items:center;gap:10px;margin:0 0 12px}
    .section-title .bar{width:28px;height:2px;background:var(--accent);opacity:.85}
    .muted{color:#9aa3b2}
    .footer{border-top:1px solid #111827;margin-top:28px;padding-top:16px;color:#9aa3b2}
    #map{height:600px;border-radius:14px;overflow:hidden}
    @media(max-width:1023px){ #map{height:380px} }

    /* 리스트 */
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .chip{
      padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;
      cursor:pointer;background:#ffffff;color:#111827;font-size:14px;font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.08)
    }
    .chip.active{outline:2px solid #111827;background:#f3f4f6}
    #place-list{list-style:none;padding:0;margin:0;display:grid;gap:10px;max-height:420px;overflow:auto}
    #place-list li{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0b1220;cursor:pointer}
    #place-list li:hover{border-color:#243043}
    #place-list .title{font-weight:700}
    #place-list .cat{font-size:12px;color:#9aa3b2}
    #detail{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .detail-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    /* 오늘 뭐먹지 */
    .pick-box{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pick-name{font-size:18px;font-weight:800}
    .pill{padding:6px 10px;border:1px solid #243043;border-radius:999px;background:#0b1220}

    /* 사다리 (데스크톱 기본) */
    #ladder-section .ladder-config{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    #ladder-section .field{display:flex;flex-direction:column;gap:6px}
    #ladder-section input[type="number"],
    #ladder-section input[type="text"]{
      width:120px;max-width:150px;padding:8px 10px;border-radius:10px;border:1px solid #243043;background:#0b1220;color:var(--text)
    }
    #ladder-section .names-grid{display:grid;gap:8px}
    #ladder-section .name-row{display:flex;gap:8px;align-items:center}
    #ladder-section .name-row input{flex:1}
    #ladder-section .btn{display:inline-block;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#fff;font-weight:700;cursor:pointer}
    #ladder-section .btn.primary{background:linear-gradient(135deg,var(--accent),#7dd3fc);color:#02131e;border-color:transparent}
    #ladder-section .btn.good{background:#10b981;color:#062015;border-color:#0e7e5a}
    #ladder-section .btn:disabled{opacity:.5;cursor:not-allowed}
    #ladder-section .muted{color:#9aa3b2}
    #ladder-section .reveal-list{display:grid;gap:6px;margin-top:10px}
    #ladder-section .reveal-item{display:flex;justify-content:space-between;gap:10px;padding:8px 12px;border:1px solid #243043;border-radius:10px;background:#0b1220}
    #ladder-section .toast{margin-top:6px;font-size:13px;color:#c7eefc;min-height:18px}
    #ladder-section .ladder-wrap{overflow:auto}
    #ladder-section svg{width:100%;min-width:560px;background:#08101b;border-radius:12px;border:1px solid #1f2937}

    /* 사다리 모바일 최적화 */
    @media (max-width: 768px){
      #ladder-section .names-grid{
        grid-template-columns: repeat(2, minmax(110px, 1fr)) !important;
        gap: 10px;
      }
      #ladder-section .name-row{flex-direction: column;align-items: stretch;gap: 6px}
      #ladder-section .name-row input{ width: 100% }
      #ladder-section .btn.good{ width: 100% }
      #ladder-section svg{ min-width: 0; height: 320px }
      #ladder-section .ladder-wrap{ margin-top: 6px }
    }
    @media (max-width: 420px){
      #ladder-section .names-grid{ grid-template-columns: 1fr !important }
      #ladder-section svg{ height: 300px }
    }

    /* ========= 비밀번호 오버레이 ========= */
    #lock-overlay{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      background:rgba(2,6,23,.88); backdrop-filter: blur(6px);
    }
    #lock-box{
      width:min(92vw, 380px);
      background:linear-gradient(180deg,#0b1220 0%,#0a0f1a 100%);
      border:1px solid var(--border);
      border-radius:16px; padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #lock-box h1{margin:0 0 8px;font-size:1.1rem}
    #lock-box p{margin:0 0 12px;color:#9aa3b2}
    #lock-box input{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #243043; background:#0b1220; color:var(--text);
    }
    #lock-actions{display:flex; gap:8px; margin-top:12px}
    #lock-actions .btn{flex:1; text-align:center; cursor:pointer}
    #lock-error{min-height:18px; margin-top:8px; color:#f87171; font-size:.9rem}
  </style>
</head>
<body>

<!-- ====== 비밀번호 오버레이 ====== -->
<div id="lock-overlay" aria-hidden="false">
  <div id="lock-box">
    <h1>U1 빌딩 맛집</h1>
    <p>접근 권한이 필요합니다. 비밀번호를 입력해 주세요.</p>
    <input id="lock-pass" type="password" inputmode="numeric" placeholder="비밀번호 (4자리)" maxlength="16" autocomplete="current-password" onkeydown="if(event.key==='Enter'){ tryEnter(); }" />
    <div id="lock-actions">
      <button id="lock-submit" class="btn primary" type="button" onclick="tryEnter()">입장</button>
      <button id="lock-clear" class="btn" type="button" onclick="clearPass()">지우기</button>
    </div>
    <div id="lock-error"></div>
  </div>
</div>

<!-- ====== 실제 앱 (잠금 해제 전까지 숨김) ====== -->
<div id="app" style="display:none">
<header>
  <div class="container">
    <nav>
      <div class="brand">U1 빌딩 <span>Matjip</span></div>
      <div class="navlinks">
        <a href="index.html">Home</a>
        <a href="stock.html">Stock Market</a>
        <a href="matjip.html">여의도</a>
        <a href="u1.html">U1</a>
        <a href="index.html#contact" class="btn primary">문의하기</a>
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid cols-2">
    <!-- 왼쪽: 지도 -->
    <section class="card" style="padding:12px">
      <div class="section-title"><div class="bar"></div><h2 style="margin:0">강동U1센터 중심 지도</h2></div>
      <div id="map"></div>
      <p class="muted" style="margin-top:8px">* 반경 내 음식점을 자동으로 불러옵니다. (카카오 지도)</p>
    </section>

    <!-- 오른쪽: 목록 + 상세 -->
    <aside class="card">
      <div class="section-title"><div class="bar"></div><h2 style="margin:0">주변 맛집</h2></div>

      <div class="filters" id="filters"></div>

      <ul id="place-list">
        <li class="muted">지도를 불러오는 중…</li>
      </ul>

      <div id="detail"></div>
    </aside>
  </div>

  <!-- 오늘 뭐먹지? -->
  <section class="card" id="what-to-eat">
    <div class="section-title"><div class="bar"></div><h2 style="margin:0">오늘 뭐먹지?</h2></div>
    <div class="pick-box">
      <span id="pick-name" class="pick-name muted">식당을 불러오는 중…</span>
      <span id="pick-meta" class="pill muted"></span>
      <button id="pick-refresh" class="btn light">다시 뽑기</button>
    </div>
    <p class="muted" style="margin-top:8px">현재 지도에 표시된(필터 반영) 식당 중 하나를 무작위로 추천합니다.</p>
  </section>

  <!-- 사다리타기 -->
  <section class="card" id="ladder-section">
    <div class="section-title"><div class="bar"></div><h2 style="margin:0">사다리타기 (3~8인)</h2></div>

    <div class="ladder-config">
      <div class="field">
        <label>인원수 (3~8)</label>
        <input type="number" id="ladder2-players" min="3" max="8" value="4"/>
      </div>
      <div class="field">
        <label>통과 개수</label>
        <input type="number" id="ladder2-pass" min="0" max="8" value="2"/>
      </div>
      <div class="field">
        <label>꽝 개수</label>
        <input type="number" id="ladder2-fail" min="0" max="8" value="2"/>
      </div>
      <div class="field" style="align-self:flex-end;">
        <button id="ladder2-start" class="btn primary">사다리 시작</button>
      </div>
      <div class="field" style="align-self:flex-end;">
        <button id="ladder2-reset" class="btn">리셋</button>
      </div>
    </div>

    <div class="names-grid" id="ladder2-names"></div>
    <div class="toast" id="ladder2-toast"></div>

    <div class="ladder-wrap" style="margin-top:10px">
      <svg id="ladder2-svg" height="420" viewBox="0 0 1000 620" preserveAspectRatio="none"></svg>
    </div>

    <div class="reveal-list" id="ladder2-reveals"></div>
  </section>

  <div class="footer">
    <small>© <span id="year"></span> U1 Matjip · 모든 권리 보유</small>
  </div>
</main>
</div> <!-- /#app -->

/* =========================
   2) 앱 부팅(카카오 SDK 동적 로드)
   ========================= */
function bootApp(){
  document.getElementById('year').textContent = new Date().getFullYear();

  // --- 동적 로드 후 kakao.maps.load(initMap) 호출 ---
  const SDK_URL = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=6096c5ef0866cfa555f1040e3f21bc62&libraries=services&autoload=false";
  loadScript(SDK_URL, () => {
    if (!window.kakao || !kakao.maps) {
      console.error('Kakao SDK 로드 실패');
      return;
    }
    kakao.maps.load(initAppLogic); // SDK 준비 후 앱 로직 시작
  });

  function loadScript(src, onload){
    const s = document.createElement('script');
    s.src = src; s.async = true; s.defer = true;
    s.onload = onload;
    s.onerror = () => console.error('SDK 스크립트 로드 에러:', src);
    document.head.appendChild(s);
  }

  /* =========================
     3) 실제 앱 로직
     ========================= */
  function initAppLogic(){
    // ===== 공통 유틸 =====
    const CATEGORIES = ['전체','한식','중식','일식','양식','카페','기타'];
    const mapCuisine = (catName='') => {
      const c = catName.toLowerCase();
      if (c.includes('한식') || c.includes('분식') || c.includes('치킨') || c.includes('고기') || c.includes('국밥')) return '한식';
      if (c.includes('중식') || c.includes('중화')) return '중식';
      if (c.includes('일식') || c.includes('스시') || c.includes('돈까스') || c.includes('라멘')) return '일식';
      if (c.includes('양식') || c.includes('이탈리아') || c.includes('피자') || c.includes('버거') || c.includes('스테이크') || c.includes('파스타')) return '양식';
      if (c.includes('카페') || c.includes('디저트') || c.includes('제과')) return '카페';
      return '기타';
    };
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const telHref = (tel='') => {
      const cleaned = (tel || '').replace(/[^\d+]/g,''); // 숫자/국가코드만
      return cleaned ? `tel:${cleaned}` : null;
    };

    // ===== 상태(지도/목록) =====
    let map, places, ALL_RESULTS=[], MARKERS=[], CURRENT_FILTER='전체', MENU_MAP=null;

    initMap(); // 지도 초기화 + 나머지 UI 셋업

    function initMap(){
      const mapEl = document.getElementById('map');
      // level:4 == 약 50m 축척
      map = new kakao.maps.Map(mapEl, { center: new kakao.maps.LatLng(37.555, 127.15), level: 4 });
      places = new kakao.maps.services.Places(map);

      const geocoder = new kakao.maps.services.Geocoder();
      geocoder.addressSearch('서울 강동구 고덕비즈밸리로 26 강동U1센터', (res, status) => {
        if (status === kakao.maps.services.Status.OK && res[0]) {
          const center = new kakao.maps.LatLng(res[0].y, res[0].x);
          map.setCenter(center);
          new kakao.maps.Marker({ map, position: center, title: '강동U1센터' });
          loadPlaces(center);
        } else {
          loadPlaces(map.getCenter());
        }
      });

      renderFilterChips();
      setupWhatToEat();
      LadderV2.setup(); // 사다리 초기화
    }

    function loadPlaces(center){
      ALL_RESULTS=[]; clearMarkers();
      const opts = { location:center, radius:800 }; // 반경 800m
      const accum = (data,status,pag)=>{
        if(status === kakao.maps.services.Status.OK){
          ALL_RESULTS = ALL_RESULTS.concat(data);
          if (pag && pag.hasNextPage) pag.nextPage();
          else { renderList(); renderMarkers(); refreshPick(); }
        }else{
          document.getElementById('place-list').innerHTML = '<li class="muted">주변에서 식당을 찾지 못했습니다.</li>';
          refreshPick();
        }
      };
      places.categorySearch('FD6', accum, opts);
    }

    function renderFilterChips(){
      const box = document.getElementById('filters');
      box.innerHTML='';
      CATEGORIES.forEach(cat=>{
        const el = document.createElement('button');
        el.className = 'chip' + (cat===CURRENT_FILTER ? ' active':'');
        el.textContent = cat;
        el.addEventListener('click', ()=>{
          CURRENT_FILTER = cat;
          document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
          el.classList.add('active');
          renderList(); renderMarkers();
          document.getElementById('detail').innerHTML='';
          refreshPick();
        });
        box.appendChild(el);
      });
    }

    const byFilter = (item) => CURRENT_FILTER==='전체' ? true : mapCuisine(item.category_name) === CURRENT_FILTER;

    function renderList(){
      const ul = document.getElementById('place-list');
      const items = ALL_RESULTS.filter(byFilter);
      if (!items.length){ ul.innerHTML = '<li class="muted">해당 분류의 식당이 없습니다.</li>'; return; }
      ul.innerHTML = '';
      items.forEach(item=>{
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="title">${item.place_name}</div>
          <div class="cat">${item.category_name} · ${item.road_address_name || item.address_name || ''}</div>
        `;
        li.addEventListener('click', ()=> showDetail(item));
        ul.appendChild(li);
      });
    }

    function clearMarkers(){ MARKERS.forEach(m=>m.setMap(null)); MARKERS=[]; }

    function renderMarkers(){
      clearMarkers();
      const items = ALL_RESULTS.filter(byFilter);
      const bounds = new kakao.maps.LatLngBounds();
      items.forEach(item=>{
        const pos = new kakao.maps.LatLng(item.y, item.x);
        const marker = new kakao.maps.Marker({ map, position: pos, title: item.place_name });
        kakao.maps.event.addListener(marker, 'click', ()=> showDetail(item));
        MARKERS.push(marker);
        bounds.extend(pos);
      });
      if (items.length) map.setBounds(bounds, 40, 40, 40, 40);
    }

    // (선택) 커스텀 메뉴 JSON
    fetch('data/menus.json').then(r=>r.ok ? r.json() : null).then(j=>MENU_MAP=j).catch(()=>{});

    function showDetail(item){
      const box = document.getElementById('detail');
      const cuisine = mapCuisine(item.category_name);
      const tel = item.phone || '';
      const addr = item.road_address_name || item.address_name || '';

      const naverLink = `https://map.naver.com/v5/search/${encodeURIComponent(item.place_name)}`;
      const googleLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.place_name + ' ' + addr)}`;

      let menuHTML = `<div class="muted">* 메뉴는 외부 페이지를 참고하세요.</div>`;
      if (MENU_MAP) {
        const key = item.id || (item.place_name + (item.phone||'')).toLowerCase();
        const custom = MENU_MAP[key];
        if (Array.isArray(custom) && custom.length){
          menuHTML = `<ul style="list-style:none;padding:0;margin-top:6px;display:grid;gap:6px">
            ${custom.map(m => `<li>· ${m.name}${m.price ? ` — <span class="muted">${m.price}</span>` : ''}</li>`).join('')}
          </ul>`;
        }
      }

      const telLink = telHref(tel);
      const telLine = tel
        ? `전화: <a href="${telLink}" class="btn call" style="padding:6px 10px;border-radius:10px;text-decoration:none">☎ ${tel}</a>`
        : `전화: <span class="muted">전화정보 없음</span>`;

      box.innerHTML = `
        <div class="section-title"><div class="bar"></div><h3 style="margin:0">${item.place_name}</h3></div>
        <p class="muted" style="margin:4px 0 10px">${item.category_name} · 분류: ${cuisine}</p>
        <p style="margin:0 0 6px">주소: ${addr}</p>
        <p style="margin:0 0 10px">${telLine}</p>
        <div><strong>메뉴</strong>${menuHTML}</div>
        <div class="detail-actions">
          <a class="btn" href="${item.place_url}" target="_blank" rel="noopener">카카오에서 보기</a>
          <a class="btn" href="${naverLink}" target="_blank" rel="noopener">네이버에서 보기</a>
          <a class="btn" href="${googleLink}" target="_blank" rel="noopener">구글에서 보기</a>
        </div>
      `;
    }

    // ===== 오늘 뭐먹지 =====
    function setupWhatToEat(){
      document.getElementById('pick-refresh').addEventListener('click', refreshPick);
    }
    const getFilteredItems = () => ALL_RESULTS.filter(byFilter);
    function refreshPick(){
      const nameEl = document.getElementById('pick-name');
      const metaEl = document.getElementById('pick-meta');
      const items = getFilteredItems();
      if (!items.length){
        nameEl.textContent = '추천할 식당이 없습니다.'; nameEl.classList.add('muted'); metaEl.textContent = ''; return;
      }
      const pick = items[Math.floor(Math.random()*items.length)];
      nameEl.textContent = pick.place_name;
      nameEl.classList.remove('muted');
      metaEl.textContent = `${pick.category_name} · ${pick.road_address_name || pick.address_name || ''}`;
    }

    // ===== 사다리 v2 (반응형) =====
    const LadderV2 = (() => {
      const MIN=3, MAX=8, DEFAULT_ROWS=12, RUNG_DENSITY=0.35;
      const $players = () => document.getElementById('ladder2-players');
      const $pass    = () => document.getElementById('ladder2-pass');
      const $fail    = () => document.getElementById('ladder2-fail');
      const $start   = () => document.getElementById('ladder2-start');
      const $reset   = () => document.getElementById('ladder2-reset');
      const $names   = () => document.getElementById('ladder2-names');
      const $svg     = () => document.getElementById('ladder2-svg');
      const $toast   = () => document.getElementById('ladder2-toast');
      const $reveals = () => document.getElementById('ladder2-reveals');

      let playerCount = 4;
      let nameList = Array.from({length:4}, (_,i)=>`참가자${i+1}`);
      let passCount = 2;
      let failCount = 2;
      let started=false;
      let ladder=null;
      let bottomResults=[];
      let revealedByTopIndex={};
      let lastSelectedIdx=null;
      let highlightPoints=null;

      const shuffle = (a)=>{ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; };
      const setToast = (msg)=> { $toast().textContent = msg||''; };
      const countsValid = ()=> (playerCount>=MIN && playerCount<=MAX && passCount>=0 && failCount>=0 && passCount+failCount===playerCount);
      const namesValid = ()=> (nameList.length===playerCount && nameList.every(n=>n.trim().length>0));

      function renderNameInputs(){
        const namesEl = $names();
        namesEl.innerHTML='';
        namesEl.style.gridTemplateColumns = `repeat(${Math.min(playerCount,4)}, minmax(160px,1fr))`;
        for(let i=0;i<playerCount;i++){
          const row=document.createElement('div'); row.className='name-row';
          const inp=document.createElement('input'); inp.type='text';
          inp.value=nameList[i]; inp.disabled=started;
          inp.placeholder=`참가자 ${i+1}`;
          inp.addEventListener('input', e=>{ nameList[i]=e.target.value; });
          const btn=document.createElement('button'); btn.className='btn good'; btn.textContent='확인';
          btn.addEventListener('click', ()=> onClickName(i));
          row.appendChild(inp); row.appendChild(btn); namesEl.appendChild(row);
        }
      }

      function generateLadder(cols, rows){
        const rungs = Array.from({length:rows}, ()=> Array(cols-1).fill(false));
        for(let r=0;r<rows;r++){
          let c=0;
          while(c<cols-1){
            if(Math.random()<RUNG_DENSITY){ rungs[r][c]=true; c+=2; } else c+=1;
          }
        }
        return { rows, cols, rungs };
      }

      function draw(){
        const svg = $svg();
        const n = playerCount;

        const wrap = document.querySelector('#ladder-section .ladder-wrap');
        const wrapW = Math.max( (wrap?.clientWidth || 600), 320 );

        const isNarrow = wrapW < 560;
        const leftPad   = isNarrow ? 40 : 60;
        const rightPad  = leftPad;
        const topPad    = isNarrow ? 32 : 40;
        const bottomPad = isNarrow ? 56 : 60;

        const innerW = wrapW - leftPad - rightPad;
        const colGap = n > 1 ? Math.max(68, innerW / (n - 1)) : 0;

        const width  = leftPad + rightPad + colGap * (n - 1);
        const height = isNarrow ? 320 : 420;
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        svg.innerHTML = '';

        // helpers
        const svgLine = (x1,y1,x2,y2,{stroke='#999',width=1}={})=>{
          const el=document.createElementNS('http://www.w3.org/2000/svg','line');
          el.setAttribute('x1',x1); el.setAttribute('y1',y1);
          el.setAttribute('x2',x2); el.setAttribute('y2',y2);
          el.setAttribute('stroke',stroke); el.setAttribute('stroke-width',width);
          return el;
        };
        const svgText = (x,y,text,{size=12,fill='#e5e7eb',weight=400}={})=>{
          const el=document.createElementNS('http://www.w3.org/2000/svg','text');
          el.setAttribute('x',x); el.setAttribute('y',y);
          el.setAttribute('text-anchor','middle'); el.setAttribute('fill',fill);
          el.style.fontSize=`${size}px`; el.style.fontWeight=String(weight);
          el.textContent=text; return el;
        };
        const svgCircle = (cx,cy,r,{fill='#000',stroke='#333'}={})=>{
          const el=document.createElementNS('http://www.w3.org/2000/svg','circle');
          el.setAttribute('cx',cx); el.setAttribute('cy',cy); el.setAttribute('r',r);
          el.setAttribute('fill',fill); el.setAttribute('stroke',stroke);
          return el;
        };

        const TOP_Y    = isNarrow ? 64 : 80;
        const BOTTOM_Y = height - (isNarrow ? 70 : 80);
        const usableH  = BOTTOM_Y - TOP_Y;

        const xs = Array.from({length:n}, (_,i)=> leftPad + colGap*i);

        // title
        svg.appendChild(svgText(width/2, isNarrow ? 28 : 36, '사다리 타기', {
          size: isNarrow ? 16 : 20, weight:700, fill:'#e5e7eb'
        }));

        // 수직선 + 상단 레이블
        xs.forEach((x,i)=>{
          const g = document.createElementNS('http://www.w3.org/2000/svg','g');
          g.appendChild(svgCircle(x, TOP_Y-24, isNarrow ? 12 : 14, {fill:'#1e293b', stroke:'#334155'}));
          g.appendChild(svgText(x, TOP_Y-20, String(i+1), {size:isNarrow?10:12, fill:'#e5e7eb'}));
          g.appendChild(svgText(x, TOP_Y-38, nameList[i], {size:isNarrow?10:12, fill:'#cbd5e1'}));
          svg.appendChild(g);
          svg.appendChild(svgLine(x, TOP_Y, x, BOTTOM_Y, {stroke:'#334155', width:isNarrow?2.5:3}));
        });

        // 가로 발판
        if(ladder){
          const ys = Array.from({length:ladder.rows}, (_,r)=> TOP_Y + (usableH*(r+1))/(ladder.rows+1));
          for(let r=0;r<ladder.rows;r++){
            for(let c=0;c<ladder.cols-1;c++){
              if(!ladder.rungs[r][c]) continue;
              svg.appendChild(svgLine(xs[c], ys[r], xs[c+1], ys[r], {stroke:'#475569', width:isNarrow?3:4}));
            }
          }
        }

        // 선택 경로 유지(리사이즈 시 재계산)
        if(lastSelectedIdx!==null && ladder){
          const {points} = tracePathPoints(lastSelectedIdx, {xs, TOP_Y, BOTTOM_Y, ladder, usableH});
          highlightPoints = points;
        }
        if(highlightPoints && highlightPoints.length){
          const poly=document.createElementNS('http://www.w3.org/2000/svg','polyline');
          poly.setAttribute('points', highlightPoints.map(p=>p.join(',')).join(' '));
          poly.setAttribute('fill','none'); poly.setAttribute('stroke','#22d3ee');
          poly.setAttribute('stroke-width', isNarrow?6:8);
          poly.setAttribute('stroke-linejoin','round'); poly.setAttribute('stroke-linecap','round');
          poly.style.filter='drop-shadow(0 0 6px rgba(34,211,238,.6))';
          svg.appendChild(poly);
        }

        // 바닥 결과
        const revealedCols = new Set(Object.values(revealedByTopIndex).map(v=>v.endCol));
        xs.forEach((x,i)=>{
          const g = document.createElementNS('http://www.w3.org/2000/svg','g');
          const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          rect.setAttribute('x', x-34); rect.setAttribute('y', BOTTOM_Y+12);
          rect.setAttribute('width', 68); rect.setAttribute('height', 26); rect.setAttribute('rx', 9);
          rect.setAttribute('fill', '#0f172a'); rect.setAttribute('stroke', '#334155');
          const t = svgText(x, BOTTOM_Y+30, revealedCols.has(i) ? bottomResults[i] : '?', {
            size: isNarrow?12:14,
            fill: revealedCols.has(i) ? (bottomResults[i]==='통과'?'#34d399':'#f87171') : '#94a3b8',
            weight:700
          });
          g.appendChild(rect); g.appendChild(t); svg.appendChild(g);
        });

        // trace helper (현 좌표계 기준)
        function tracePathPoints(startCol, ctx){
          const xs_ = ctx?.xs || xs;
          const TOP = ctx?.TOP_Y || TOP_Y;
          const BTM = ctx?.BOTTOM_Y || BOTTOM_Y;
          const rows = ladder?.rows || 0;
          const h = (ctx?.usableH ?? (BTM - TOP));
          if(!ladder) return {points:[], endCol:startCol};
          let col=startCol; const pts=[];
          pts.push([xs_[col], TOP]);
          for(let r=0;r<rows;r++){
            const y = TOP + (h*(r+1))/(rows+1);
            pts.push([xs_[col], y]);
            if(ladder.rungs[r][col]){ pts.push([xs_[col+1], y]); col=col+1; }
            else if(col>0 && ladder.rungs[r][col-1]){ pts.push([xs_[col-1], y]); col=col-1; }
          }
          pts.push([xs_[col], BTM]);
          return {points:pts, endCol:col};
        }
        draw._trace = (i)=> tracePathPoints(i);
      }

      function onStart(){
        setToast('');
        if(!countsValid()){ setToast('인원수와 통과/꽝 개수의 합이 인원수와 같아야 합니다.'); return; }
        if(!namesValid()){ setToast('이름을 모두 입력해 주세요.'); return; }

        ladder = generateLadder(playerCount, DEFAULT_ROWS);
        bottomResults = shuffle([ ...Array(passCount).fill('통과'), ...Array(playerCount - passCount).fill('꽝') ]);
        revealedByTopIndex = {}; highlightPoints=null; lastSelectedIdx=null; started=true;

        $players().disabled = true; $pass().disabled = true; $fail().disabled = true;
        $names().querySelectorAll('input').forEach(i=> i.disabled = true);
        draw();
      }

      function onReset(){
        playerCount = 4; passCount=2; failCount=2;
        nameList = Array.from({length:playerCount}, (_,i)=>`참가자${i+1}`);
        ladder=null; bottomResults=[]; revealedByTopIndex={}; highlightPoints=null; lastSelectedIdx=null; started=false; setToast('');
        $players().disabled=false; $pass().disabled=false; $fail().disabled=false;
        $players().value='4'; $pass().value='2'; $fail().value='2'; renderNameInputs(); draw();
        $reveals().innerHTML='';
      }

      function onClickName(idx){
        if(!started || !ladder){ setToast("먼저 '사다리 시작'을 눌러 게임을 시작하세요."); return; }
        lastSelectedIdx = idx;
        const {points, endCol} = (draw._trace ? draw._trace(idx) : {points:[], endCol:idx});
        const result = bottomResults[endCol];
        highlightPoints = points;
        revealedByTopIndex[idx] = { endCol, result };
        addRevealItem(idx, endCol, result);
        setToast(`${nameList[idx]}: ${result==='통과' ? '통과!' : '꽝'}`);
        draw();
      }

      function addRevealItem(topIdx, endCol, result){
        let row = document.getElementById(`ladder2-re-${topIdx}`);
        const text = `${nameList[topIdx]} → ${result} (도착 ${endCol+1})`;
        if(!row){
          row = document.createElement('div'); row.id=`ladder2-re-${topIdx}`;
          row.className='reveal-item';
          const left=document.createElement('div'); left.textContent=text;
          left.style.color = result==='통과' ? '#34d399' : '#fca5a5';
          const btn=document.createElement('button'); btn.className='btn primary'; btn.style.padding='6px 8px'; btn.style.fontSize='12px'; btn.textContent='경로 보기';
          btn.addEventListener('click', ()=>{ lastSelectedIdx=topIdx; const {points}=draw._trace(topIdx); highlightPoints=points; draw(); });
          row.appendChild(left); row.appendChild(btn); $reveals().appendChild(row);
        }else{
          row.firstChild.textContent = text;
          row.firstChild.style.color = result==='통과' ? '#34d399' : '#fca5a5';
        }
      }

      function setToast(msg){ $toast().textContent = msg||''; }
      function syncFailToPlayers(){
        failCount = clamp(playerCount - passCount, 0, playerCount);
        $fail().value = String(failCount);
      }

      function bindEvents(){
        $players().addEventListener('input', e=>{
          playerCount = clamp(parseInt(e.target.value||'4',10), MIN, MAX);
          e.target.value = String(playerCount);
          if(nameList.length<playerCount){ for(let i=nameList.length;i<playerCount;i++) nameList.push(`참가자${i+1}`); }
          else if(nameList.length>playerCount){ nameList.length=playerCount; }
          syncFailToPlayers(); renderNameInputs(); draw();
        });
        $pass().addEventListener('input', e=>{
          passCount = clamp(parseInt(e.target.value||'0',10), 0, playerCount);
          e.target.value = String(passCount);
          syncFailToPlayers(); draw();
        });
        $fail().addEventListener('input', e=>{
          failCount = clamp(parseInt(e.target.value||'0',10), 0, playerCount);
          e.target.value = String(failCount); draw();
        });

        $start().addEventListener('click', onStart);
        $reset().addEventListener('click', onReset);

        // 화면 리사이즈 시 다시 그리기
        window.addEventListener('resize', ()=> draw());
      }

      function setup(){
        playerCount = clamp(parseInt($players().value||4,10),MIN,MAX);
        nameList = Array.from({length:playerCount}, (_,i)=>`참가자${i+1}`);
        passCount = clamp(parseInt($pass().value||2,10),0,playerCount);
        failCount = clamp(parseInt($fail().value||2,10),0,playerCount);
        bindEvents(); renderNameInputs(); draw();
      }
      return { setup };
    })();

    // expose for init
    window.LadderV2 = LadderV2;
  }
}
</script>

<!-- ==== 전역 bootApp: SDK 동적 로드 + 지도 최소 초기화 ==== -->
<script id="boot-app">
window.bootApp = function bootApp(){
  var SDK_URL = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=6096c5ef0866cfa555f1040e3f21bc62&libraries=services&autoload=false";

  // 이미 로드되어 있으면 재사용
  if (window.kakao && kakao.maps && kakao.maps.load) {
    kakao.maps.load(init);
    return;
  }

  // SDK 동적 로드
  var s = document.createElement('script');
  s.src = SDK_URL; s.async = true; s.defer = true;
  s.onload = function(){
    if (!window.kakao || !kakao.maps) {
      console.error('[Kakao] SDK 로드 실패');
      return;
    }
    kakao.maps.load(init);
  };
  s.onerror = function(){
    console.error('[Kakao] SDK 스크립트 로드 오류');
  };
  document.head.appendChild(s);

  // SDK 준비 후 실행 (지도로 최소 확인)
  function init(){
    try {
      var mapEl = document.getElementById('map');
      if (!mapEl) { console.error('[Map] #map 요소 없음'); return; }

      // level: 4 ≈ 약 50m
      var map = new kakao.maps.Map(mapEl, {
        center: new kakao.maps.LatLng(37.555, 127.15),
        level: 4
      });

      var geocoder = new kakao.maps.services.Geocoder();
      geocoder.addressSearch('서울 강동구 고덕비즈밸리로 26 강동U1센터', function(res, status){
        if (status === kakao.maps.services.Status.OK && res[0]){
          var center = new kakao.maps.LatLng(res[0].y, res[0].x);
          map.setCenter(center);
          new kakao.maps.Marker({ map: map, position: center, title: '강동U1센터' });
        } else {
          console.warn('[Geocode] 주소검색 실패, 기본 좌표 유지');
        }
      });
    } catch(e){
      console.error('[Map] 초기화 오류:', e);
    }
  }
};
</script>
            
<script>
/* ===== LOCK SAFE MODE =====
   - 이벤트 리스너 없이 onclick/onkeydown으로 직접 호출
   - 실패 시 콘솔/alert로 바로 확인 가능
*/
(function(){
  // 요소 캐시
  var PASS = '1004';
  var overlay = document.getElementById('lock-overlay');
  var app = document.getElementById('app');
  var input = document.getElementById('lock-pass');
  var err = document.getElementById('lock-error');

  // 방어: 요소 누락 시 알림
  if(!overlay || !app || !input || !err){
    console.error('[LOCK] 요소를 찾지 못했습니다.', { overlay, app, input, err });
  }

  // 전역 함수로 노출 (onclick에서 사용)
  window.tryEnter = function(){
    try {
      var v = (input && input.value ? input.value.trim() : '');
      if (v === PASS) {
        if (err) err.textContent = '';
        if (overlay) overlay.style.display = 'none';
        if (app) app.style.display = 'block';
        // 앱 부팅 시도
        try {
          if (typeof bootApp === 'function') {
            bootApp();
          } else {
            console.warn('[LOCK] bootApp 함수가 정의되지 않았습니다.');
            alert('비번 통과! 하지만 bootApp이 정의되어 있지 않아 앱을 시작하지 못했습니다.');
          }
        } catch(e){
          console.error('[LOCK] bootApp 실행 오류:', e);
          alert('비번 통과했지만 앱 시작 중 오류가 발생했습니다. 콘솔을 확인하세요.');
        }
      } else {
        if (err) err.textContent = '비밀번호가 올바르지 않습니다.';
        if (input) { input.select(); input.focus(); }
      }
    } catch (e){
      console.error('[LOCK] tryEnter 예외:', e);
      alert('입장 처리 중 오류가 발생했습니다. 콘솔을 확인하세요.');
    }
  };

  window.clearPass = function(){
    try {
      if (input) input.value = '';
      if (err) err.textContent = '';
      if (input) input.focus();
    } catch(e){
      console.error('[LOCK] clearPass 예외:', e);
    }
  };

  // 초기에 포커스
  try { setTimeout(function(){ if(input) input.focus(); }, 0); } catch(e){}
})();
</script>

</body>
</html>
